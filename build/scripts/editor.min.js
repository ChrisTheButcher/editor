/*! Editor 2014-05-13 */
(function($) { if (!$) { throw new "jQuery was not loaded"; }var KeyInfo=function(){this.pressed="Unknown",this.modifiers=[],this.is=function(a){var b=a.replace(/ /gi,"").split("+");if(b.length>1)for(var c=0;c<b.length-1;c++)if(-1===this.modifiers.indexOf(b[c]))return!1;return this.pressed==b[b.length-1]}},Keys={_keys:{8:"Backspace",9:"Tab",13:"Enter",16:"Shift",17:"Ctrl",18:"Alt",20:"Caps",27:"Esc",32:"Space",33:"PageUp",34:"PageDown",35:"End",36:"Home",37:"Left",38:"Up",39:"Right",40:"Down",45:"Insert",46:"Delete",65:"A",66:"B",67:"C",68:"D",69:"E",70:"F",71:"G",72:"H",73:"I",74:"J",75:"K",76:"L",77:"M",78:"N",79:"O",80:"P",81:"Q",82:"R",83:"S",84:"T",85:"U",86:"V",87:"W",88:"X",89:"Y",90:"Z",91:"Cmd",144:"NumLock"},info:function(a){var b=new KeyInfo;return b.pressed=Keys._keys[a.which],(a.ctrlKey||a.metaKey)&&b.modifiers.push(Keys._keys[17]),a.shiftKey&&b.modifiers.push(Keys._keys[16]),a.altKey&&b.modifiers.push(Keys._keys[18]),b}};window.Keys=Keys;var PluginManager={baseUrl:"/plugins/",plugins:{},scriptsLoading:0,scriptsLoadingTimeout:null,scriptFiles:[],pluginLoadingDone:function(){},scriptLoaded:function(){this.scriptsLoading-=1,this.scriptsLoadingTimeout&&clearTimeout(this.scriptsLoadingTimeout),this.scriptsLoadingTimeout=setTimeout(function(){PluginManager.pluginLoadingDone()},10)},loadFile:function(a,b){if(!this.plugins[a])throw"Plugin "+a+" must be loaded before loading an additional file";a=this.plugins[a],$.ajax({url:PluginManager.baseUrl+a.name+"/"+b,success:function(c){a.files[b]=c}})},loadPluginFile:function(a){for(var b in this.scriptFiles)if(this.scriptFiles[b]==a)return!1;var c=document.createElement("script");return this.scriptsLoading+=1,c.async=!0,c.src=PluginManager.baseUrl+a+"/script.js",c.onload=function(){PluginManager.scriptLoaded(a),PluginManager.scriptFiles.push(a)},document.body.appendChild(c),!0},get:function(a){return PluginManager.plugins[a]},createPlugin:function(a,b){PluginManager.plugins[a]=$.extend({files:{},name:a,loadFile:function(a){PluginManager.loadFile(this.name,a)},init:function(){}},b)}};window.PluginManager=PluginManager;var HtmlEngine=function(a){this.options=$.extend({mode:"html5",useCss:!1},a)},ElementList={bold:["b","strong",function(a){return a&&"bold"==a.style.fontWeight&&"span"==a.nodeName.toLowerCase()}],italic:["i","em",function(a){return a&&"italic"==a.style.fontStyle&&"span"==a.nodeName.toLowerCase()}],underline:["u","u",function(a){return a&&"underline"==a.style.fontStyle&&"span"==a.nodeName.toLowerCase()}]};HtmlEngine.prototype={lineBreak:function(){return document.createElement("br")},convert:{toHTML:function(a){return a},toWidget:function(a){var b=document.createElement("div"),c=$(a);if(b.className="ed-widget",b.style.width=(c.width()<10?500:c.width())+"px",b.style.height=(c.height()<10?351:c.height())+"px",a.src.indexOf("youtube")>-1||a.src.indexOf("youtu.be")>-1){var d="";d=a.src.indexOf("embed")>-1?a.src.split("/embed/")[1]:a.src.indexOf("?v")>-1?a.src.split("?v=")[1]:a.src.split("/")[a.src.split("/").length-1],b.className+=" ed-widget-youtube",b.style.backgroundImage="url(http://img.youtube.com/vi/"+d+"/0.jpg)"}return b},toCode:function(a){var b=$("<div/>").html(a),c=this;return b.find("iframe").each(function(){var a=$(c.toWidget(this));a.attr("data-src",$(this).attr("src")),$(this).after(a).remove()}),b.html()}},content:function(){return document.createElement("p")},bold:function(){if("html5"==this.options.mode)return document.createElement("strong");if(this.options.useCss){var a=document.createElement("span");return a.style.fontWeight="bold",a}return document.createElement("b")},getContentNode:function(a){var b=["p","div","h1","h2","h3","h4","h5","h6","ul","ol"];return-1===b.indexOf(a.nodeName.toLowerCase())?a.parentNode?this.getContentNode(a.parentNode):!1:a},listItem:function(){return document.createElement("li")},italic:function(){if("html5"==this.options.mode)return document.createElement("em");if(this.options.useCss){var a=document.createElement("span");return a.style.fontStyle="italic",a}return document.createElement("i")},underline:function(){if("html5"==this.options.mode)return document.createElement("u");if(this.options.useCss){var a=document.createElement("span");return a.style.fontStyle="underline",a}return document.createElement("u")},isElement:function(a,b,c,d){var e=ElementList[b],f=a.nodeName.toLowerCase(),d=d?d:0;if(3===a.nodeType)return"textNode"===b;if(!e)return c&&a.parentNode&&99999>d?this.isElement(a.parentNode,b,!0,d+1):!1;for(var g in e){var h=e[g];if(f==("function"==typeof h?h(a):h))return!0}}},window.HtmlEngine=HtmlEngine;var $htmlTemplate=function(){var a='<div class="ed-container">   <div class="ed-overlay">   </div>   <div class="ed-header">        <div class="ed-header-inner">        </div>   </div>   <div class="ed-content">       <iframe class="ed-content-frame"></iframe>   </div></div>';return $(a)},C={log:function(){},error:function(){},warn:function(){}};"undefined"!=typeof console&&console.log&&(C=console);var Editor=function(a){this.options=a,this.options.stylesheets||C.warn("Please specify at least one stylesheet")};Editor.prototype={isBound:!1,isRendered:!1,boundPlugins:[],buttons:[],unbind:function(){},bind:function(){var a=this;this.$frameDoc.find("body").keydown(function(b){var c=Keys.info(b);if(c.is("Shift + Enter"))b.preventDefault(),a.insertAtCursor(a.engine.lineBreak()),a.insertAtCursor(a.engine.lineBreak());else if(c.is("Enter")){b.preventDefault();var d=a.getRange(0);if("p"==d.endContainer.nodeName.toLowerCase()||d.endContainer.parentNode&&"p"==d.endContainer.parentNode.nodeName.toLowerCase()){{var e="p"==d.endContainer.parentNode.nodeName.toLowerCase()?d.endContainer.parentNode:d.endContainer,f=a.engine.content();$(e).after(f)}d.setStart(f,0),d.setEnd(f,0)}else{if(!(d.endContainer.parentNode&&["ul","ol","li"].indexOf(d.endContainer.parentNode.nodeName.toLowerCase())>-1))return void a.insertAtCursor(a.engine.content());var g=d.endContainer.parentNode;if(0===g.innerHTML.length||["ul","ol"].indexOf(g.nodeName.toLowerCase())>-1){{var f=a.engine.content();$("li"==g.nodeName.toLowerCase()?d.endContainer.parentNode.parentNode:d.endContainer.parentNode).after(f)}d.setStart(f,0),d.setEnd(f,0)}else{{var f=a.engine.listItem();$(d.endContainer.parentNode).after(f)}d.setStart(f,0),d.setEnd(f,0)}}var h=a.getSelection();h.removeAllRanges(),h.addRange(d)}c.is("Ctrl + B")&&(b.preventDefault(),a.toggleStyle("bold")),c.is("Ctrl + I")&&(b.preventDefault(),a.toggleStyle("italic")),c.is("Ctrl + U")&&(b.preventDefault(),a.toggleStyle("underline"))})},toggleStyle:function(a){var b=this.getRange();if(b=b.endContainer.parentNode&&this.engine.isElement(b.endContainer.parentNode,a,!1)?this.unsurroundCursor():this.surroundCursor(this.engine[a]())){var c=this.getSelection();c.removeAllRanges(),c.addRange(b)}},showScreen:function(a){this.$overlay.addClass("active").html(a)},hideScreen:function(){var a=this;this.$editor.css("display","block"),setTimeout(function(){a.$editor.css("display","table"),a.$overlay.removeClass("active").html("")},40)},addButton:function(a,b){this.buttons.push($.extend({icon:!1,name:a,click:function(){},getElement:function(){var a=$("<i/>").addClass("fa fa-"+this.icon),b=$("<a/>").attr("href","#").attr("title",this.name).addClass("ed-icon");return b.append(a)}},b))},addSelect:function(a,b){this.buttons.push($.extend({icon:!1,name:a,click:function(){},getElement:function(){var a=$("<div/>").addClass("ed-select"),b=$("<i/>").addClass("fa fa-angle-down"),c=$("<span/>").html(this.text||this.options[0].key);a.append(b).append(c);var d=$("<div/>").addClass("ed-select-inner");for(var e in this.options){var f=this.options[e];d.append($("<div/>").addClass("ed-select-option").html(f.key).data("opt",f))}return a.append(d)}},b))},addEvent:function(a,b,c){this.$frameBody.on(a,b,c)},bindButton:function(a){var b=null;for(var c in this.buttons)if(this.buttons[c].name==a){b=this.buttons[c];break}var d=b.getElement();if(b&&d){var e=this,f=$(d);this.$editorHeader.append(f),f.hasClass("ed-select")?(f.hover(function(a){a.preventDefault(),f.find(".ed-select-inner").slideToggle(100)},function(a){a.preventDefault(),f.find(".ed-select-inner").slideToggle(100)}),f.find(".ed-select-option").click(function(a){b.click.apply(b,[$(this).data("opt"),e,a])})):f.click(function(a){a.preventDefault(),b.click.apply(b,[e,a])})}},getSelection:function(){return window.getSelection?this.$frameDoc[0].getSelection():void C.error("Shitty browsers are currently not supported, sorry")},getRange:function(a){return this.getSelection().getRangeAt(a?a:0)},calculateWordOffset:function(a,b,c){for(var d=0,e=0,f=b-1;f>=0;f--)if(" "==a[f]||!a[f]){d=" "==a[f]?f+1:f;break}for(var f=b;f>=c;f++)if(" "==a[f]||!a[f]||f==a.length){e=f;break}return{startOffset:d,endOffset:e}},unsurroundCursor:function(){var a=this.getRange(0),b=a.endContainer.parentNode,c=a.endContainer,d=[a.startOffset,a.endOffset];return b&&$(b).replaceWith(this.unwrap(b)),a.selectNode(c),a.setStart(c,d[0]),a.setEnd(c,d[1]),a},unwrap:function(a){$(a).contents().filter(function(){return 3===this.nodeType}).unwrap()},surroundCursor:function(a){{var b=this.getRange(0);$(a)[0]}if(b.startOffset-b.endOffset===0){var c=this.calculateWordOffset($(b.endContainer).text(),b.startOffset,b.endOffset);b.setStart(b.endContainer,c.startOffset),b.setEnd(b.endContainer,c.endOffset)}return b.surroundContents(a),b},insertAtCursor:function(a){var b=this.getSelection(),c=b.getRangeAt(0),d=$(a)[0];return c.insertNode(d),c.setStart(d,0),c.setEnd(d,0),b.removeAllRanges(),b.addRange(c),c},insertAfterCursor:function(a){var b=this.getSelection(),c=b.getRangeAt(0),d=$(a)[0];return $(c.endContainer).after(d),this.$frameBody.focus(),c.setStart(d,0),c.setEnd(d,0),b.removeAllRanges(),b.addRange(c),c},insertAfterCursorElement:function(a){var b=this.getSelection(),c=b.getRangeAt(0),d=$(a)[0],e=this.engine.getContentNode(c.endContainer);return e&&($(e).after(d),this.$frameBody.focus(),c.setStart(d,0),c.setEnd(d,0),b.removeAllRanges(),b.addRange(c)),c},loadHtml:function(a){this.$frameBody.html(this.engine.convert.toCode(a))},buildHead:function(a){var b="<title>Editor</title>";return a.styles.push("styles/font-awesome.min.css"),a.styles.push("styles/editor-inline.min.css"),$.each(a.styles,function(){b+='<link rel="stylesheet" type="text/css" href="'+this+'" />\n'}),b},makeEditable:function(a){a.attr("contentEditable","true").attr("designMode","on")},bindPlugin:function(a){return this.boundPlugins[a.name]?!1:(this.boundPlugins[a.name]=a,a.init.apply(a,[this]),!0)},__render:function(a){a=a||"";var b=this;this.engine=new HtmlEngine,this.$editor=$htmlTemplate(this.options),this.$editorHeader=this.$editor.find(".ed-header-inner"),this.$element.hide(),this.$element.after(this.$editor),this.$frame=this.$editor.find("iframe"),this.$frameDoc=$(this.$frame[0].contentWindow.document),this.$frameBody=this.$frameDoc.find("body"),this.$overlay=this.$editor.find(".ed-overlay"),this.$frameDoc.find("head").html(this.buildHead({styles:this.options.stylesheets,scripts:[]})),this.makeEditable(this.$frameDoc.find("body")),this.loadHtml(a);for(var c in this.options.plugins)this.bindPlugin(this.plugins.get(this.options.plugins[c]));for(var c in this.options.menu)this.bindButton(this.options.menu[c]);this.$editor.on("click",".ed-close-overlay",function(){b.hideScreen()}),this.$frameBody.on("mouseup mousedown",function(a){b.$frameBody.find(".ed-element-focus").removeClass("ed-element-focus"),$(b.engine.getContentNode(a.target)).addClass("ed-element-focus")}),this.$frameBody.on("keyup keydown",function(){var a=b.getRange(0);b.$frameBody.find(".ed-element-focus").removeClass("ed-element-focus"),$(b.engine.getContentNode(a.endContainer)).addClass("ed-element-focus")}),this.bind()},render:function(a){if(this.isRendered)this.bind();else{this.$element=a,this.plugins=PluginManager;for(var b in this.options.plugins)this.plugins.loadPluginFile(this.options.plugins[b]),this.boundPlugins.push(b);var c=this;this.plugins.pluginLoadingDone=function(){c.__render(c.$element.is("textarea")||c.$element.is("input")?c.$element.val():c.$element.html())}}}},$.fn.editify=function(a){var b=$.extend({menu:["bold","italic","underline","styles"],plugins:["basic_formatting","widgets"]},a),c=null;return $(this).each(function(){var a=$(this);a.data("jq.editor")&&a.data("jq.editor").unbind(),c=new Editor(b),c.render(a)}),$(this).first().data("jq.editor",c)};}(jQuery));