/*! Editor 2014-05-13 */
(function($) { if (!$) { throw "jQuery not loaded"; } var KeyInfo=function(){this.pressed="Unknown",this.modifiers=[],this.is=function(a){var b=a.replace(/ /gi,"").split("+");if(b.length>1)for(var c=0;c<b.length-1;c++)if(-1===this.modifiers.indexOf(b[c]))return!1;return this.pressed==b[b.length-1]}},Keys={_keys:{8:"Backspace",9:"Tab",13:"Enter",16:"Shift",17:"Ctrl",18:"Alt",20:"Caps",27:"Esc",32:"Space",33:"PageUp",34:"PageDown",35:"End",36:"Home",37:"Left",38:"Up",39:"Right",40:"Down",45:"Insert",46:"Delete",65:"A",66:"B",67:"C",68:"D",69:"E",70:"F",71:"G",72:"H",73:"I",74:"J",75:"K",76:"L",77:"M",78:"N",79:"O",80:"P",81:"Q",82:"R",83:"S",84:"T",85:"U",86:"V",87:"W",88:"X",89:"Y",90:"Z",91:"Cmd",144:"NumLock"},info:function(a){var b=new KeyInfo;return b.pressed=Keys._keys[a.which],(a.ctrlKey||a.metaKey)&&b.modifiers.push(Keys._keys[17]),a.shiftKey&&b.modifiers.push(Keys._keys[16]),a.altKey&&b.modifiers.push(Keys._keys[18]),b}};window.Keys=Keys;var PluginManager={baseUrl:"plugins/",plugins:{},scriptsLoading:0,scriptsLoadingTimeout:null,scriptFiles:[],pluginLoadingDone:function(){},scriptLoaded:function(){this.scriptsLoading-=1,this.scriptsLoadingTimeout&&clearTimeout(this.scriptsLoadingTimeout),this.scriptsLoadingTimeout=setTimeout(function(){PluginManager.pluginLoadingDone()},10)},loadFile:function(a,b){if(!this.plugins[a])throw"Plugin "+a+" must be loaded before loading an additional file";a=this.plugins[a],$.ajax({url:PluginManager.baseUrl+a.name+"/"+b,success:function(c){a.files[b]=c}})},loadPluginFile:function(a){for(var b in this.scriptFiles)if(this.scriptFiles[b]==a)return!1;var c=document.createElement("script");return this.scriptsLoading+=1,c.async=!0,c.src=PluginManager.baseUrl+a+"/script.js",c.onload=function(){PluginManager.scriptLoaded(a),PluginManager.scriptFiles.push(a)},document.body.appendChild(c),!0},get:function(a){return PluginManager.plugins[a]},createPlugin:function(a,b){PluginManager.plugins[a]=$.extend({files:{},name:a,loadFile:function(a){PluginManager.loadFile(this.name,a)},init:function(){}},b)}};window.PluginManager=PluginManager;var HtmlEngine=function(a){if("string"==typeof a){var b=[];for(var c in arguments)b.push(arguments[c]);return HtmlEngine.createElement.apply(HtmlEngine,b)}this.options=$.extend({mode:"html5",useCss:!1},a)},AllElementsList=["a","abbr","acronym","address","applet","area","article","aside","audio","b","base","basefont","bdi","bdo","bgsound","big","blink","blockquote","body","br","button","canvas","caption","center","cite","code","col","colgroup","content","data","datalist","dd","decorator","del","details","dfn","dir","div","dl","dt","element","em","embed","fieldset","figcaption","figure","font","footer","form","frame","frameset","h1","h2","h3","h4","h5","h6","head","header","hgroup","hr","html","i","iframe","img","input","ins","isindex","kbd","keygen","label","legend","li","link","listing","main","map","mark","marquee","menu","menuitem","meta","meter","nav","nobr","noframes","noscript","object","ol","optgroup","option","output","p","param","plaintext","pre","progress","q","rp","rt","ruby","s","samp","script","section","select","shadow","small","source","spacer","span","strike","strong","style","sub","summary","sup","table","tbody","td","template","textarea","tfoot","th","thead","time","title","tr","track","tt","u","ul","var","video","wbr","xmp"],ElementList={bold:["b","strong",function(a){return a&&"bold"==a.style.fontWeight&&"span"==a.nodeName.toLowerCase()}],italic:["i","em",function(a){return a&&"italic"==a.style.fontStyle&&"span"==a.nodeName.toLowerCase()}],underline:["u","u",function(a){return a&&"underline"==a.style.fontStyle&&"span"==a.nodeName.toLowerCase()}]};HtmlEngine.prototype={lineBreak:function(){return document.createElement("br")},convert:{toHTML:function(a){return a},toWidget:function(a){var b=document.createElement("div"),c=$(a);if(b.className="ed-widget",b.style.width=(c.width()<10?500:c.width())+"px",b.style.height=(c.height()<10?351:c.height())+"px",a.src.indexOf("youtube")>-1||a.src.indexOf("youtu.be")>-1){var d="";d=a.src.indexOf("embed")>-1?a.src.split("/embed/")[1]:a.src.indexOf("?v")>-1?a.src.split("?v=")[1]:a.src.split("/")[a.src.split("/").length-1],b.className+=" ed-widget-youtube",b.style.backgroundImage="url(http://img.youtube.com/vi/"+d+"/0.jpg)"}return b},toCode:function(a){var b=HtmlEngine("div").html(a),c=this;return b.find("iframe").each(function(){var a=$(c.toWidget(this));a.attr("data-src",$(this).attr("src")),$(this).after(a).remove()}),b.html()}},content:function(){return document.createElement("p")},bold:function(){if("html5"==this.options.mode)return document.createElement("strong");if(this.options.useCss){var a=document.createElement("span");return a.style.fontWeight="bold",a}return document.createElement("b")},getContentNode:function(a){var b=["p","div","h1","h2","h3","h4","h5","h6","ul","ol"];return-1===b.indexOf(a.nodeName.toLowerCase())?a.parentNode?this.getContentNode(a.parentNode):!1:a},listItem:function(){return document.createElement("li")},italic:function(){if("html5"==this.options.mode)return document.createElement("em");if(this.options.useCss){var a=document.createElement("span");return a.style.fontStyle="italic",a}return document.createElement("i")},underline:function(){if("html5"==this.options.mode)return document.createElement("u");if(this.options.useCss){var a=document.createElement("span");return a.style.fontStyle="underline",a}return document.createElement("u")},isContentElement:function(a){return this.getContentNode(a)!==!1},getElement:function(a){return 3===a.nodeType?a.parentNode?this.getElement(a.parentNode):!1:a},isElement:function(a,b,c,d){var e=ElementList[b],f=a.nodeName.toLowerCase(),d=d?d:0;if(3===a.nodeType)return"textNode"===b;if(!e)return c&&a.parentNode&&99999>d?this.isElement(a.parentNode,b,!0,d+1):!1;for(var g in e){var h=e[g];if(f==("function"==typeof h?h(a):h))return!0}}},HtmlEngine.createElement=function(a){if(AllElementsList.indexOf(a)>-1)return $(document.createElement(a));var b=a.match(/[#\.\[]{1}([a-zA-Z= \"_\-,\?]*)/g),c=a.match(/^[a-zA-Z]*/),d=document.createElement(0===c[0].length?"div":c[0]),e=arguments,f=1;for(var g in b){var h=b[g],i=h.substr(1);switch(h[0]){case".":d.className+=" "+i;break;case"#":d.id=i;break;case"[":var j=i.split(", ");for(var k in j){var l=j[k].split("="),m=l[0],n="?"==l[1]?e[f].toString():l[1].substr(1,l[1].length-2);"?"==l[1]&&f++,d.setAttribute(m,n)}}}return d.className.length>0&&(d.className=d.className.substr(1)),$(d)},window.HtmlEngine=HtmlEngine;var $htmlTemplate=function(){var a='<div class="ed-container">   <div class="ed-overlay">   </div>   <div class="ed-header">        <div class="ed-header-inner">        </div>   </div>   <div class="ed-content">       <iframe class="ed-content-frame"></iframe>   </div></div>';return $(a)},C={log:function(){},error:function(){},warn:function(){}};"undefined"!=typeof console&&console.log&&(C=console);var Editor=function(a){this.options=a,this.options.stylesheets||C.warn("Please specify at least one stylesheet")};Editor.prototype={isBound:!1,isRendered:!1,boundPlugins:[],buttons:[],unbind:function(){this.$frameBody.unbind("keydown"),this.$editor.off("click","**"),this.$frameBody.off("mouseup mousedown keyup keydown","**")},bind:function(){var a=this;this.$editor.on("click",".ed-close-overlay",function(){a.hideScreen()}),this.$frameBody.on("mouseup mousedown",function(){var b=a.getRange(0);b&&(a.$frameBody.find(".ed-element-focus").removeClass("ed-element-focus"),$(a.engine.getContentNode(b.endContainer)).addClass("ed-element-focus"))}),this.$frameBody.on("keyup keydown",function(){a.$frameBody.find(".ed-element-focus").removeClass("ed-element-focus"),$(a.engine.getContentNode(a.getRange(0).endContainer)).addClass("ed-element-focus")}),this.$frameBody.find("body").keydown(function(b){var c=Keys.info(b),d=a.getRange(0);if(c.is("Shift + Enter")){b.preventDefault();var e=document.createTextNode("_"),f=$(a.engine.lineBreak()).after(e);d.insertNode(f[0]),d.setStart(e,0),d.setEnd(e,0),a.focusRange(d),e.nodeValue=""}else if(c.is("Enter")){b.preventDefault();var g=a.engine.getElement(d.endContainer),h=$(g),i=a.engine.content();if(h.is("p,h1,h2,h3,h4,h5,h6,table,blockquote"))h.after(i),d.setStart(i,0),d.setEnd(i,0);else{if(!$(d.endContainer.parentNode).is("ul,ol,li"))return void a.insertAtCursor(a.engine.content());var j=d.endContainer.parentNode;0===j.innerHTML.length||$(j).is("ol,ul")?$("li"==j.nodeName.toLowerCase()?d.endContainer.parentNode.parentNode:d.endContainer.parentNode).after(i):$(d.endContainer.parentNode).after(i),d.setStart(i,0),d.setEnd(i,0)}a.focusRange(d)}c.is("Ctrl + B")&&(b.preventDefault(),a.toggleStyle("bold")),c.is("Ctrl + I")&&(b.preventDefault(),a.toggleStyle("italic")),c.is("Ctrl + U")&&(b.preventDefault(),a.toggleStyle("underline"))})},toggleStyle:function(a){var b=this.getRange();b=b.endContainer.parentNode&&this.engine.isElement(b.endContainer.parentNode,a,!1)?this.unsurroundCursor():this.surroundCursor(this.engine[a]()),b&&this.focusRange(b)},focusRange:function(a){var b=ed.getSelection();b.removeAllRanges(),b.addRange(a)},showScreen:function(a){this.$overlay.addClass("active").html(a)},hideScreen:function(){var a=this;this.$editor.css("display","block"),setTimeout(function(){a.$editor.css("display","table"),a.$overlay.removeClass("active").html("")},40)},addButton:function(a,b){this.buttons.push($.extend({icon:!1,name:a,click:function(){},getElement:function(){var a=HtmlEngine("i.fa.fa-"+this.icon),b=HtmlEngine('a.ed-icon[href="", title=?]',this.name);return b.append(a)}},b))},addSelect:function(a,b){this.buttons.push($.extend({icon:!1,name:a,click:function(){},getElement:function(){var a=HtmlEngine(".ed-select"),b=HtmlEngine("i.fa.fa-angle-down"),c=HtmlEngine("span").html(this.text||this.options[0].key);a.append(b).append(c);var d=HtmlEngine(".ed-select-inner");for(var e in this.options){var f=this.options[e];d.append(HtmlEngine(".ed-select-option").html(f.key).data("opt",f))}return a.append(d)}},b))},addEvent:function(a,b,c){this.$frameBody.on(a,b,c)},bindButton:function(a){var b=null;for(var c in this.buttons)if(this.buttons[c].name==a){b=this.buttons[c];break}var d=b.getElement();if(b&&d){var e=this,f=$(d);this.$editorHeader.append(f),f.hasClass("ed-select")?(f.hover(function(a){a.preventDefault(),f.find(".ed-select-inner").slideToggle(100)},function(a){a.preventDefault(),f.find(".ed-select-inner").slideToggle(100)}),f.find(".ed-select-option").click(function(a){b.click.apply(b,[$(this).data("opt"),e,a])})):f.click(function(a){a.preventDefault(),b.click.apply(b,[e,a])})}},getSelection:function(){return window.getSelection?this.$frameDoc[0].getSelection():void C.error("Shitty browsers are currently not supported, sorry")},getRange:function(a){var b=this.getSelection();return"None"==b.type?!1:this.getSelection().getRangeAt(a?a:0)},calculateWordOffset:function(a,b,c){for(var d=0,e=0,f=b-1;f>=0;f--)if(" "==a[f]||!a[f]){d=" "==a[f]?f+1:f;break}for(var f=b;f>=c;f++)if(" "==a[f]||!a[f]||f==a.length){e=f;break}return{startOffset:d,endOffset:e}},unsurroundCursor:function(){var a=this.getRange(0),b=a.endContainer.parentNode,c=a.endContainer,d=[a.startOffset,a.endOffset];return b&&$(b).replaceWith(this.unwrap(b)),a.selectNode(c),a.setStart(c,d[0]),a.setEnd(c,d[1]),a},unwrap:function(a){$(a).contents().filter(function(){return 3===this.nodeType}).unwrap()},surroundCursor:function(a){{var b=this.getRange(0);$(a)[0]}if(b.startOffset-b.endOffset===0){var c=this.calculateWordOffset($(b.endContainer).text(),b.startOffset,b.endOffset);b.setStart(b.endContainer,c.startOffset),b.setEnd(b.endContainer,c.endOffset)}return b.surroundContents(a),b},insertAtCursor:function(a){var b=sel.getRangeAt(0),c=$(a)[0];return b.insertNode(c),b.setStart(c,0),b.setEnd(c,0),this.focusRange(b),b},insertAfterCursor:function(a){var b=sel.getRangeAt(0),c=$(a)[0];return $(b.endContainer).after(c),this.$frameBody.focus(),b.setStart(c,0),b.setEnd(c,0),this.focusRange(b),b},insertAfterCursorElement:function(a){var b=sel.getRangeAt(0),c=$(a)[0],d=this.engine.getContentNode(b.endContainer);return d&&($(d).after(c),this.$frameBody.focus(),b.setStart(c,0),b.setEnd(c,0),this.focusRange(b)),b},loadHtml:function(a){this.$frameBody.html(this.engine.convert.toCode(a))},buildHead:function(a){var b=HtmlEngine("head").append(HtmlEngine("title").html("Editor"));return a.styles.push(this.options.baseUrl+"styles/font-awesome.min.css"),a.styles.push(this.options.baseUrl+"styles/editor-inline.min.css"),$.each(a.styles,function(){b.append(HtmlEngine('link[rel="stylesheet", href=?]',this))}),b[0]},makeEditable:function(a){a.attr("contentEditable","true").attr("designMode","on")},bindPlugin:function(a){return this.boundPlugins[a.name]?!1:(this.boundPlugins[a.name]=a,a.init.apply(a,[this]),!0)},__render:function(a){a=a||"";this.engine=new HtmlEngine,this.$editor=$htmlTemplate(this.options),this.$editorHeader=this.$editor.find(".ed-header-inner"),this.$element.hide(),this.$element.after(this.$editor),this.$frame=this.$editor.find("iframe"),this.$frameDoc=$(this.$frame[0].contentWindow.document),this.$frameBody=this.$frameDoc.find("body"),this.$overlay=this.$editor.find(".ed-overlay"),this.$frameDoc.find("head").html(this.buildHead({styles:this.options.stylesheets,scripts:[]}).innerHTML),this.makeEditable(this.$frameBody),this.loadHtml(!a||a&&0==a.length?this.engine.content():a);for(var b in this.options.plugins)this.bindPlugin(this.plugins.get(this.options.plugins[b]));for(var b in this.options.menu)this.bindButton(this.options.menu[b]);this.bind()},render:function(a){if(this.isRendered)this.bind();else{this.$element=a,this.plugins=PluginManager,this.options.baseUrl&&(this.plugins.baseUrl=this.options.baseUrl+"plugins/");for(var b in this.options.plugins)this.plugins.loadPluginFile(this.options.plugins[b]),this.boundPlugins.push(b);var c=this;this.plugins.pluginLoadingDone=function(){c.__render(c.$element.is("textarea")||c.$element.is("input")?c.$element.val():c.$element.html())}}}},$.fn.editify=function(a){var b=$.extend({menu:["bold","italic","underline","styles"],plugins:["basic_formatting","widgets"],stylesheets:[]},a),c=null;return $(this).each(function(){var a=$(this);a.data("jq.editor")&&a.data("jq.editor").unbind(),c=new Editor(b),c.render(a)}),$(this).first().data("jq.editor",c)};}(jQuery));